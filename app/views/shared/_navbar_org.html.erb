<%# --- FLEXBOX HEADER LAYOUT: 3 columns, 2 center rows --- %>
<div class="org-header-flex" style="position:fixed; top:0; width:100%; z-index:10; background:#212529; display:flex; align-items:stretch; min-height:87px;">
  <!-- LEFT COLUMN: Org name/logo -->
  <div class="org-header-left d-flex align-items-center justify-content-start px-3" style="flex:0 0 auto;">
    <% if @organization.present? %>
      <%= link_to organization_path(@organization), class: "navbar-brand fw-bold text-truncate my-0 py-0", style: "color:#fff;" do %>
        <i class="fas fa-building me-2"></i><span style="max-width:120px; display:inline-block; vertical-align:middle; color:#fff;" class="text-truncate"><%= @organization.name %></span>
      <% end %>
    <% else %>
      <%= link_to root_path, class: "navbar-brand fw-bold my-0 py-0", style: "color:#fff;" do %>
        <i class="fas fa-paw me-2"></i>PetForce
      <% end %>
    <% end %>
  </div>

  <!-- CENTER COLUMN: 2 rows (search, then nav/tabs/3-dots) -->
  <div class="org-header-center d-flex flex-column justify-content-center" style="flex:1 1 0; min-width:0;">
    <!-- Row 1: Search bar -->
    <div class="org-header-search d-flex justify-content-center align-items-center py-2" style="width:100%;">
      <%= render 'shared/search_bar', organization: @organization %>
    </div>
    <!-- Row 2: Main nav, tabs, 3-dots -->
    <div class="org-header-navrow d-flex align-items-center">
      <!-- Main nav dropdown -->
      <div class="navbar-nav align-items-center my-0 py-0">
        <div class="nav-item dropdown">
          <a class="main-nav-link dropdown-toggle d-flex align-items-center" href="#" id="mainNavDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-bars me-2"></i>
            <% if @organization.present? %>
              <% if current_page?(organization_path(@organization)) %>
                Home
              <% elsif current_page?(organization_pets_path(@organization)) || (request.path.match?(/\/organizations\/\d+\/pets\/\d+/) && !request.path.match?(/\/pets\/\d+\/(edit|new)/)) %>
                Pets
              <% elsif current_page?(organization_events_path(@organization)) || request.path.match?(/\/organizations\/\d+\/events\/\d+/) %>
                Calendar
              <% elsif current_page?(organization_tasks_path(@organization)) || request.path.match?(/\/organizations\/\d+\/tasks\/\d+/) %>
                Tasks
              <% elsif current_page?(feed_index_path) %>
                Social
              <% else %>
                Navigation
              <% end %>
            <% else %>
              Navigation
            <% end %>
          </a>
          <ul class="dropdown-menu" style="z-index:20;">
            <li>
              <%= link_to (@organization.present? ? organization_path(@organization) : root_path), class: "dropdown-item d-flex align-items-center py-2 #{current_page?(@organization.present? ? organization_path(@organization) : root_path) ? 'active' : ''}" do %>
                <i class="fas fa-home me-3 text-muted"></i>
                <span>Home</span>
              <% end %>
            </li>
            <% if @organization.present? %>
              <li>
                <%= link_to organization_pets_path(@organization), class: "dropdown-item d-flex align-items-center py-2 #{current_page?(organization_pets_path(@organization)) || (request.path.match?(/\/organizations\/\d+\/pets\/\d+/) && !request.path.match?(/\/pets\/\d+\/(edit|new)/)) ? 'active' : ''}" do %>
                  <i class="fas fa-paw me-3 text-muted"></i>
                  <span>Pets</span>
                <% end %>
              </li>
              <li>
                <%= link_to organization_events_path(@organization), class: "dropdown-item d-flex align-items-center py-2 #{current_page?(organization_events_path(@organization)) || request.path.match?(/\/organizations\/\d+\/events\/\d+/) ? 'active' : ''}" do %>
                  <i class="fas fa-calendar me-3 text-muted"></i>
                  <span>Calendar</span>
                <% end %>
              </li>
              <li>
                <%= link_to organization_tasks_path(@organization), class: "dropdown-item d-flex align-items-center py-2 #{current_page?(organization_tasks_path(@organization)) || request.path.match?(/\/organizations\/\d+\/tasks\/\d+/) ? 'active' : ''}" do %>
                  <i class="fas fa-tasks me-3 text-muted"></i>
                  <span>Tasks</span>
                <% end %>
              </li>
            <% end %>
            <li>
              <%= link_to feed_index_path, class: "dropdown-item d-flex align-items-center py-2 #{current_page?(feed_index_path) ? 'active' : ''}" do %>
                <i class="fas fa-users me-3 text-muted"></i>
                <span>Social</span>
              <% end %>
            </li>
          </ul>
        </div>
      </div>
      <!-- Tabs (flex:1, min-width:0, scrollable) -->
      <div class="d-flex align-items-center" style="flex:1 1 0; min-width:0; overflow-x:auto;">
        <%= render 'shared/tabbed_navigation' %>
      </div>
      <!-- 3-dots dropdown -->
      <div class="dropdown ms-3" style="flex-shrink:0;">
        <a class="btn btn-sm btn-outline-secondary dropdown-toggle px-2 py-1" href="#" id="tabMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Tab actions" role="button">
          <i class="fas fa-ellipsis-h fa-lg"></i>
        </a>
        <ul class="dropdown-menu dropdown-menu-end mt-1" aria-labelledby="tabMenuDropdown" style="min-width: 180px;">
          <li><hr class="tab-menu-divider"></li>
          <li><a class="dropdown-item" href="#" data-action="tabbed-navigation#unpinAllTabs">Unpin all tabs</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- RIGHT COLUMN: User/settings nav -->
  <div class="org-header-right d-flex align-items-center justify-content-end px-3" style="flex:0 0 auto; min-width:80px;">
    <% if user_signed_in? && current_user.impersonated? %>
      <div class="nav-item me-3">
        <div class="alert alert-warning mb-0 py-1 px-2 small">
          <i class="fas fa-user-secret me-1"></i>
          Impersonating: <%= current_user.email %>
          <%= button_to "Stop", stop_impersonating_user_path(current_user), method: :delete, class: "btn btn-warning btn-sm ms-2" %>
        </div>
      </div>
    <% end %>
    <div class="nav-item dropdown">
      <a class="user-nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-user-circle me-2"></i>
      </a>
      <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0" aria-labelledby="userDropdown" style="min-width: 220px; z-index:20;">
        <li class="dropdown-header text-muted small px-3 py-2">
          <i class="fas fa-user me-2"></i>Account
        </li>
        <li>
          <%= link_to edit_user_registration_path, class: "dropdown-item d-flex align-items-center py-2" do %>
            <i class="fas fa-user-cog me-3 text-muted"></i>
            <span>Profile Settings</span>
          <% end %>
        </li>
        <% if current_user.shelter_staff? || current_user.admin? %>
          <% if @organization.present? %>
            <li><hr class="dropdown-divider"></li>
            <li class="dropdown-header text-muted small px-3 py-2">
              <i class="fas fa-cog me-2"></i>Organization
            </li>
            <li>
              <%= link_to edit_organization_path(@organization), class: "dropdown-item d-flex align-items-center py-2" do %>
                <i class="fas fa-building me-3 text-muted"></i>
                <span>Edit Organization</span>
              <% end %>
            </li>
            <li>
              <%= link_to organization_organization_fields_path(@organization), class: "dropdown-item d-flex align-items-center py-2" do %>
                <i class="fas fa-list me-3 text-muted"></i>
                <span>Manage Fields</span>
              <% end %>
            </li>
          <% end %>
        <% end %>
        <% if current_user.admin? || (current_user.shelter_staff? && current_user.organizations.size > 1) %>
          <li>
            <%= link_to organizations_path, class: "dropdown-item d-flex align-items-center py-2" do %>
              <i class="fas fa-exchange-alt me-3 text-muted"></i>
              <span>Switch Organizations</span>
            <% end %>
          </li>
        <% end %>
        <li><hr class="dropdown-divider"></li>
        <li>
          <%= button_to destroy_user_session_path, method: :delete, class: "dropdown-item d-flex align-items-center py-2 text-danger", form: { data: { turbo: false } } do %>
            <i class="fas fa-sign-out-alt me-3"></i>
            <span>Sign Out</span>
          <% end %>
        </li>
      </ul>
    </div>
  </div>
</div>
<%# REMINDER: Add margin-top to main content to offset header height %>
