<%= form_with(model: [@organization, calendar], local: true) do |form| %>
  <% if calendar.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(calendar.errors.count, "error") %> prohibited this calendar from being saved:</h4>
      <ul>
        <% calendar.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-8">
      <div class="mb-3">
        <%= form.label :name, class: "form-label" %>
        <%= form.text_field :name, class: "form-control", required: true %>
      </div>

      <div class="mb-3">
        <%= form.label :description, class: "form-label" %>
        <%= form.text_area :description, class: "form-control", rows: 3 %>
      </div>

      <div class="mb-3">
        <%= form.label :color, class: "form-label" %>
        <div class="d-flex align-items-center">
          <%= form.color_field :color, class: "form-control form-control-color me-2", style: "width: 60px;" %>
          <span class="text-muted">Choose a color for this calendar</span>
        </div>
      </div>

      <div class="mb-3">
        <div class="form-check">
          <%= form.check_box :is_public, class: "form-check-input" %>
          <%= form.label :is_public, "Make this calendar public", class: "form-check-label" %>
        </div>
        <small class="form-text text-muted">
          Public calendars are visible to all organization members. Private calendars are only visible to you and administrators.
        </small>
      </div>

      <!-- Calendar Sharing Section -->
      <% if @calendar.persisted? %>
        <div class="card mt-4" 
             data-controller="calendar-sharing"
             data-share-url="<%= organization_calendar_calendar_shares_path(@organization, @calendar) %>">
          <div class="card-header">
            <h6 class="card-title mb-0">Share Calendar</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Share with organization members:</label>
              <select class="form-select" 
                      data-calendar-sharing-target="userSelect"
                      data-action="change->calendar-sharing#userSelected">
                <option value="">Select a user...</option>
                <% @organization.users.each do |user| %>
                  <option value="<%= user.id %>"><%= user.full_name %> (<%= user.email %>)</option>
                <% end %>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Or share with email address:</label>
              <input type="email" 
                     class="form-control" 
                     data-calendar-sharing-target="emailInput"
                     data-action="input->calendar-sharing#emailChanged"
                     placeholder="Enter email address">
            </div>
            
            <div class="mb-3">
              <label class="form-label">Permission level:</label>
              <select class="form-select" data-calendar-sharing-target="permissionSelect">
                <option value="view">View only</option>
                <option value="edit">Can edit events</option>
                <option value="manage">Can manage calendar</option>
              </select>
            </div>
            
            <button type="button" 
                    class="btn btn-primary" 
                    data-calendar-sharing-target="shareBtn"
                    data-action="click->calendar-sharing#share">
              Share Calendar
            </button>
          </div>
        </div>
      <% end %>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Calendar Preview</h5>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <span class="calendar-color-indicator" style="background-color: <%= calendar.color || '#3788d8' %>"></span>
            <span class="fw-bold"><%= calendar.name.present? ? calendar.name : 'Calendar Name' %></span>
          </div>
          <p class="text-muted small mb-2">
            <%= calendar.description.present? ? calendar.description : 'No description' %>
          </p>
          <span class="badge <%= calendar.is_public ? 'bg-success' : 'bg-secondary' %>">
            <%= calendar.is_public ? 'Public' : 'Private' %>
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4">
    <%= form.submit class: "btn btn-primary" %>
    <%= link_to "Cancel", organization_calendars_path(@organization), class: "btn btn-secondary" %>
  </div>
<% end %>

<style>
.calendar-color-indicator {
  display: inline-block;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  margin-right: 8px;
  border: 2px solid #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
</style> 